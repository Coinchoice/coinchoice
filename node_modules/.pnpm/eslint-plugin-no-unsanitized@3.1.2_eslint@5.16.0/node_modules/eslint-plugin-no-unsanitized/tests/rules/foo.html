<h1 id="h.etybcz8cg1xn"><span class="c6 c15">Testing Firefox&#39;s Hardening against Privileged XSS</span>
</h1><p ><span>For those few who&#39;ve followed along, I gave a talk and blogged about</span><span><a
         href="https://frederik-braun.com/firefox-ui-xss-leading-to-rce.html>&nbsp;</a></span><span class="
        c13"><a  href="https://frederik-braun.com/firefox-ui-xss-leading-to-rce.html">how to achieve &quot;critical&quot;-rated code execution vulnerabilities in Firefox with user-interface XSS</a></span><span>. The end of the blog posts invites people to test the sanitizers but did not come with proper instructions. This is what </span><span
        >this</span><span >&nbsp;blog post is going to follow-up on</span></p><p ><span>In the meantime, colleagues from Security Engineering managed to ship a strong</span><span><a
         href="https://blog.mozilla.org/security/2019/10/14/hardening-firefox-against-injection-attacks/">&nbsp;</a></span><span
        ><a href="https://blog.mozilla.org/security/2019/10/14/hardening-firefox-against-injection-attacks/">Content-Security-Policy (CSP) for all our privileged internal </a></span><span
        class="c13 c10"><a 
                           href="https://blog.mozilla.org/security/2019/10/14/hardening-firefox-against-injection-attacks/">about</a></span><span
        ><a 
                       href="https://blog.mozilla.org/security/2019/10/14/hardening-firefox-against-injection-attacks/">: pages</a></span><span>&nbsp;(e.g.: </span><span
        >about:preferences</span><span>, which hosts Firefox settings). We also disallow </span><span
        >eval()</span><span >&nbsp;and raise an assertion for use in privileged code.</span></p><p
        ><span>This means that a successful exploit has to bypass our built-in XSS sanitizer and Content-Security Policy (CSP) to gain arbitrary code execution. This blog post does not talk about CSP bypasses. However a bypass of the sanitizer by itself is still a security bug and probably warrants a bounty. (Typical restrictions apply. I am not the bug bounty committee. I am not a lawyer See the</span><span><a
         href="https://www.mozilla.org/en-US/security/bug-bounty/">&nbsp;</a></span><span ><a
         href="https://www.mozilla.org/en-US/security/bug-bounty/">bounty pages</a></span><span >&nbsp;for more)</span>
</p><h2  id="h.qs36dp474wak"><span class="c12 c6">How and where to test Firefox Security</span></h2><p
        ><span>A browser is a complex beast. If you want to do meaningful security research, you should test Firefox Nightly. We often times rewrite lots of code that isn&#39;t related to the thing you are testing but will still have an impact. To make sure your bug is actually going to affect end users, test</span><span><a
         href="https://nightly.mozilla.org/">&nbsp;</a></span><span ><a 
                                                                                             href="https://nightly.mozilla.org/">Firefox Nightly</a></span><span
        >. Otherwise, the things you find in Beta or Release might have already been fixed in Nightly.</span>
</p><h2  id="h.8xucxkksast1"><span class="c6 c12">Sanitizer runs in all privileged pages</span></h2><h4
         id="h.1zsvx7ygolaq"><span class="c14 c6 c17">about:config</span></h4><p ><span>The sanitizer is available to all privileged pages. You can test it with the Firefox Developer Tools. Just open a new tab and navigate to </span><span
        >about:config</span><span >. about:config. has access to privileged APIs and therefore can not use innerHTML (and its friends) without going through the sanitizer.</span>
</p><h4  id="h.94sgm2rws32e"><span >Developer Tools</span></h4><p ><span>Open The developer tools. Go to </span><span
        >Tools</span><span>&nbsp;in the menu bar. Select </span><span >Web Developers</span><span>, then </span><span
        >Web Console</span><span >&nbsp;(Ctrl+Shift+k). Try XSSing yourself, type:</span></p><p
        ><span class="c10 c14">document.body.innerHTML = &#39;&lt;img src=x onerror=alert(1)&gt;&#39;</span>
</p><p ><span
        >Observe how Firefox sanitizes the HTML markup by looking at the error in the console: </span></p><p
        class="c4 c16"><span >&ldquo;Removed unsafe attribute. Element: img. Attribute: onerror.&rdquo;</span>
</p><p ><span >You may now go and try other variants of XSS against this sanitizer. Or read on to know how it actually works.</span>
</p><h4  id="h.2pb4v3f0dxuc"><span >Sanitizer Source code</span></h4><p ><span>The Sanitizer runs in the so-called</span><span><a
         href="https://w3c.github.io/DOM-Parsing/%23dfn-fragment-parsing-algorithm">&nbsp;</a></span><span
        ><a  href="https://w3c.github.io/DOM-Parsing/%23dfn-fragment-parsing-algorithm">&quot;fragment parsing&quot;</a></span><span>&nbsp;step of innerHTML. Whenever someone uses innerHTML (or its friends, like outerHTML) the browser parses the string from JavaScript and builds a DOM tree data structure. Now before the structure is appended to the existing DOM element our sanitizer kicks in. This makes sure that our sanitizer can not mismatch with the actual parser. It </span><span
        >is</span><span>&nbsp;the actual parser. The code line that triggers the sanitizer is in</span><span><a
        
        href="https://searchfox.org/mozilla-central/rev/171109434c6f2fe086af3b2322839b346a112a99/dom/base/nsContentUtils.cpp%234683">&nbsp;</a></span><span
        ><a 
                       href="https://searchfox.org/mozilla-central/rev/171109434c6f2fe086af3b2322839b346a112a99/dom/base/nsContentUtils.cpp%234683">nsContentUtils::ParseFragmentHTML</a></span><span>&nbsp;and </span><span
        >nsContentUtils::ParseFragmentXML</span><span >. This link here points to a specific source code revision, to make hotlinking easier. Please click the file name at the top of the page to get to a newer revision of the source code.</span>
</p><p >
    <span>The sanitizer is implemented as an allow-list of elements, attributes and attribute values in</span><span><a
        
        href="https://searchfox.org/mozilla-central/source/dom/base/nsTreeSanitizer.cpp">&nbsp;</a></span><span
        ><a  href="https://searchfox.org/mozilla-central/source/dom/base/nsTreeSanitizer.cpp">nsTreeSanitizer.cpp</a></span><span
        >. Please consult the list before wasting CPU cycles.</span></p><p ><span >Finding a Sanitizer bypass is a hunt for mXSS bugs in Firefox.</span><span
        >&nbsp;&ndash; Unless you find an element in our allow-list that has recently become capable of running script.</span>
</p><h3  id="h.wjd6961cloyh"><span >So, what about the actual XSS?</span></h3><p ><span>Right, so for now we have </span><span
        >emulated</span><span>&nbsp;the Cross-Site Scripting (XSS) vulnerability by typing in </span><span
        >innerHTML</span><span >&nbsp;ourselves in the Web Console. That&#39;s pretty much cheating. But as I said above: What we want to find are sanitizer bypasses. This is a call to test our mitigations.</span>
</p><p ><span>But if you still want to find real XSS bugs in Firefox, I recommend you run some sort of smart static analysis on the Firefox JavaScript code. And by smart, I probably do not mean</span><span><a
         href="https://github.com/mozilla/eslint-plugin-no-unsanitized">&nbsp;</a></span><span ><a
        
        href="https://github.com/mozilla/eslint-plugin-no-unsanitized0">eslint-plugin-no-unsanitized</a></span><span
        >. But I&#39;m not gonna judge you :-)</span></p><h2  id="h.2vb8xel3fjdh"><span
        class="c12 c6">Conclusion</span></h2><p ><span>This blog post describes the mitigations Mozilla Firefox has in place to protect against XSS bugs that lead to remote code execution outside of the sandbox. If you intend to search and take part in the Bug Bounty program, please consult the</span><span><a
         href="https://www.mozilla.org/en-US/security/bug-bounty/">&nbsp;</a></span><span ><a
         href="https://www.mozilla.org/en-US/security/bug-bounty/">Bug Bounty pages</a></span><span
        >.</span></p></body></html>